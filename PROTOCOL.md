# مستندات پروتکل رخشان

این سند پروتکل‌های کلیدی افزایش حریم خصوصی را که در سرور رخشان پیاده‌سازی شده‌اند، تشریح می‌کند. این پروتکل‌ها برای محافظت از فراداده (metadata) کاربران و دشوار کردن تحلیل ترافیک طراحی شده‌اند.

## ۱. فرستنده پنهان (Sealed Sender)

برای محافظت از هویت فرستنده پیام، سرور از مدل "فرستنده پنهان" استفاده می‌کند.

- **نحوه کار:** هنگامی که کلاینت پیامی ارسال می‌کند، درخواست (`POST /api/messages`) شامل `conversationId`، `recipientId` و یک `ciphertextPayload` است. نکته مهم این است که این درخواست **فاقد `senderId`** می‌باشد.
- **نقش سرور:** سرور تأیید می‌کند که کاربر احراز هویت شده (از طریق توکن JWT) عضوی از `conversationId` است، اما **هرگز شناسه فرستنده را در رکورد پیام در پایگاه داده ذخیره نمی‌کند.**
- **نتیجه:** اگر یک مهاجم به پایگاه داده پیام‌ها دسترسی پیدا کند، نمی‌تواند تشخیص دهد چه کسی کدام پیام را ارسال کرده است. مدل `Message` در پایگاه داده فقط یک پیام را به یک گفتگو و یک گیرنده مرتبط می‌کند. هویت فرستنده موقتی است و فقط برای شرکت‌کنندگان آن گفتگو مشخص است.

## ۲. پنهان‌سازی ترافیک (Traffic Obfuscation)

سرور از دو مکانیزم برای پنهان‌سازی الگوهای ترافیک شبکه استفاده می‌کند تا تحلیل رفتار کاربر بر اساس حجم و زمان‌بندی ترافیک را برای ناظران دشوارتر سازد.

- **Padding سمت سرور (پاسخ):** به هر پاسخی که از سرور به کلاینت ارسال می‌شود، با احتمال تصادفی، یک مقدار Padding با حجم تصادفی (بین ۱۰ تا ۵۰۰ بایت) در هدر HTTP به نام `X-Padding` اضافه می‌شود.
- **تأخیر سمت سرور (پاسخ):** هر پاسخ سرور قبل از ارسال، به مدت زمانی تصادفی (بین ۵۰ تا ۳۰۰ میلی‌ثانیه) دچار تأخیر می‌شود.
- **Padding سمت کلاینت (درخواست):** سرور طوری پیکربندی شده است که با کلاینت‌هایی که در درخواست‌های خود Padding ارسال می‌کنند (مثلاً در هدر `X-Client-Padding`) کار کند. اگرچه این مورد به طور پیش‌فرض اجباری نیست، اما به عنوان یک رفتار مورد انتظار از کلاینت در نظر گرفته شده است.

این اقدامات به جداسازی حجم و زمان‌بندی اقدامات واقعی کاربر از ترافیک قابل مشاهده شبکه کمک می‌کنند.

## ۳. حالت مخفی و ترافیک جعلی (Stealth Mode & Decoy Traffic)

"حالت مخفی" یک ویژگی قابل فعال‌سازی توسط کاربر است که برای ایجاد یک لایه اضافی از انکارپذیری قابل قبول طراحی شده است.

- **فعال‌سازی:** کاربر یک رمز عبور یک‌بار مصرف (OTP) تولید کرده و از آن برای فعال کردن حالت مخفی برای حساب کاربری خود به مدت محدود (مثلاً ۱ ساعت) استفاده می‌کند. وضعیت فعال‌سازی در Redis ذخیره می‌شود.
- **تولید ترافیک جعلی:** هنگامی که حالت مخفی برای یک کاربر فعال است، سرور به طور خودکار برای او ترافیک جعلی تولید می‌کند.
- **نحوه کار:** یک فرآیند پس‌زمینه هر ۵ ثانیه روی سرور اجرا می‌شود. این فرآیند تمام کاربران آنلاین را بررسی می‌کند. اگر کاربری حالت مخفی را فعال کرده باشد، سرور یک بسته داده جعلی و رمزنگاری‌شده را از طریق اتصال WebSocket به آن کاربر ارسال می‌کند. این ترافیک تحت رویداد `fake_traffic` ارسال می‌شود.
- **نتیجه:** این کار یک جریان از ترافیک شبکه با ظاهر واقعی اما بی‌معنی برای کاربر ایجاد می‌کند که به پنهان کردن فعالیت واقعی پیام‌رسانی او کمک می‌کند. یک ناظر جریانی ثابت از داده‌ها را مشاهده خواهد کرد که تشخیص زمان ارسال یا دریافت پیام‌های واقعی را دشوار می‌سازد.
