# گزارش ارزیابی جامع پروژه رخشان

## خلاصه مدیریتی

*   **امتیاز فرانت‌اند:** 11/40
*   **امتیاز بک‌اند:** 23/40
*   **امتیاز هماهنگی:** 10/20
*   **امتیاز کل: 44/100**

*   **۳ نکته قوت اصلی:**
    1.  **معماری امنیتی و حریم خصوصی در بک‌اند:** استفاده از تکنیک‌های پیشرفته مانند جلوگیری از حملات timing و شمارش نام کاربری، هشینگ قوی با Argon2 و رمزنگاری فراداده‌های گفتگو، نشان‌دهنده درک عمیق از مسائل حریم خصوصی است.
    2.  **پیاده‌سازی هماهنگ پنهان‌سازی ترافیک:** مکانیزم‌های Padding و تأخیر تصادفی به صورت هماهنگ در فرانت‌اند (با Axios interceptor) و بک‌اند (با Express middleware) پیاده‌سازی شده‌اند.
    3.  **پوشش تست خوب در بک‌اند:** بک‌اند دارای مجموعه تست‌های جامعی است که تمام بخش‌های اصلی برنامه را پوشش می‌دهد و همگی با موفقیت اجرا می‌شوند.

*   **۳ ریسک/ضعف اصلی:**
    1.  **پیاده‌سازی شکسته و ناامن رمزنگاری سرتاسری (E2EE):** هم در بک‌اند (مدیریت نادرست کلیدهای یک‌بار مصرف) و هم در فرانت‌اند (خطاهای متعدد نوعی و پیاده‌سازی)، مکانیزم E2EE که هسته اصلی امنیت برنامه است، به درستی کار نمی‌کند و آسیب‌پذیری‌های حیاتی دارد.
    2.  **فرانت‌اند غیرقابل بیلد و پر از خطای TypeScript:** پروژه فرانت‌اند به دلیل تعداد بسیار زیاد خطاهای نوعی (Type Errors) قابل بیلد شدن برای محیط پروداکشن نیست. استفاده گسترده از `any` امنیت نوع را از بین برده و کد را مستعد باگ کرده است.
    3.  **مغایرت حیاتی بین مستندات و پیاده‌سازی:** پروتکل "Sealed Sender" که یکی از ویژگی‌های کلیدی حریم خصوصی پروژه است، در عمل پیاده‌سازی نشده و با مستندات در تضاد کامل قرار دارد.

---

### جزئیات

#### **فرانت‌اند (11/40)**

*   **کیفیت کُد و معماری (4/8):**
    *   **شواهد:** ساختار پوشه‌ها (`components`, `hooks`, `pages`) خوب است، اما خروجی `eslint` (50 خطا) و استفاده گسترده از `any` در فایل‌هایی مانند `lib/crypto.ts` و `store/authStore.ts` کیفیت را به شدت پایین می‌آورد.
    *   **پیشنهاد:** معرفی قوانین سخت‌گیرانه‌تر برای `eslint` (مانند `@typescript-eslint/no-explicit-any`) و بازنویسی بخش‌های کلیدی برای استفاده از انواع داده صحیح.
*   **عملکرد (1/8):**
    *   **شواهد:** پروژه با `npm run build` به دلیل بیش از ۱۰۰ خطای TypeScript بیلد نمی‌شود. (خروجی `tsc` را ببینید).
    *   **پیشنهاد:** اولویت اول باید رفع تمام خطاهای TypeScript باشد تا پروژه قابل بیلد شود.
*   **UX/A11y (3/6):** (ارزیابی محدود به دلیل عدم اجرای کامل)
    *   **شواهد:** ساختار کامپوننت‌ها منطقی به نظر می‌رسد، اما بدون اجرای کامل، ارزیابی دقیق ممکن نیست.
*   **State/Query (4/6):**
    *   **شواهد:** استفاده از Zustand (`store/authStore.ts`) انتخاب خوبی است. استفاده از Axios Interceptor (`api/axios.ts`) برای padding عالی است.
    *   **پیشنهاد:** رفع خطاهای `any` در استورهای Zustand.
*   **امنیت کلاینت (1/6):**
    *   **شواهد:** پیاده‌سازی شکسته E2EE در `lib/crypto.ts` و فایل‌های وابسته، امنیت کلاینت را بی‌معنی می‌کند.
    *   **پیشنهاد:** بازنویسی کامل لایه رمزنگاری با پیروی دقیق از پروتکل Signal و رفع خطاهای TypeScript.
*   **تست‌ها (2/6):**
    *   **شواهد:** تست‌ها (`npm run test`) با وجود خطاهای زمان اجرا پاس می‌شوند که نشان‌دهنده پیکربندی نادرست `vitest` و assertion های ضعیف است. (خروجی `stderr` در تست‌ها را ببینید).
    *   **پیشنهاد:** هماهنگ‌سازی `vitest` با `tsc` برای گزارش خطاهای نوعی. تقویت assertion ها برای شناسایی خطاهای زمان اجرا.

#### **بک‌اند (23/40)**

*   **معماری/کیفیت (5/8):**
    *   **شواهد:** معماری لایه‌ای خوب (`controllers`, `models`). کد امن در `authController.js`. اما مدیریت خطای ناهماهنگ و منطق ناقص در `messageController.js`.
    *   **پیشنهاد:** استفاده از یک میان‌افزار مدیریت خطای متمرکز و استاندارد.
*   **طراحی API (6/8):**
    *   **شواهد:** Rate limiting به درستی در `routes/auth.js` پیاده‌سازی شده. اما مغایرت بزرگ "Sealed Sender".
    *   **پیشنهاد:** فیلد `senderId` از مدل `Message` حذف شود تا با مستندات هماهنگ گردد.
*   **دیتابیس (5/6):**
    *   **شواهد:** مدل‌ها با تمرکز بر حریم خصوصی طراحی شده‌اند (`Conversation.js`). اما وجود `senderId` در `Message.js` یک ضعف است.
    *   **پیشنهاد:** حذف فیلد `senderId` از مدل `Message`.
*   **عملکرد/مقیاس (4/6):**
    *   **شواهد:** استفاده از ایندکس در مدل‌ها خوب است. ارسال دسته‌ای پیام‌ها یک نقطه قوت است.
*   **امنیت (2/6):**
    *   **شواهد:** **آسیب‌پذیری حیاتی** در `keyController.js` (مدیریت نادرست کلیدهای یک‌بار مصرف). وجود کلیدهای تست در ریپازیتوری (`test_private.pem`).
    *   **پیشنهاد:** بازنویسی کامل `keyController.js` با پیروی از بهترین شیوه‌های X3DH. حذف تمام کلیدهای خصوصی از ریپازیتوری.
*   **تست‌ها/مشاهده‌پذیری (5/6):**
    *   **شواهد:** پوشش تست بک‌اند با `npm test` خوب است. اما لاگ‌گیری ساختاریافته نیست.
    *   **پیشنهاد:** استفاده از یک کتابخانه لاگ‌گیری مانند Winston یا Pino برای لاگ‌های ساختاریافته.

#### **هماهنگی (10/20)**

*   **مغایرت‌ها:**
    *   **مغایرت Sealed Sender (حیاتی):** مستندات (`PROTOCOL.md`) ادعا می‌کند `senderId` ذخیره نمی‌شود، اما فیلد آن در مدل `Message.js` وجود دارد.
    *   **مغایرت انواع داده (بالا):** خطاهای بیلد فرانت‌اند نشان‌دهنده ناهماهنگی شدید بین انواع داده تعریف‌شده و داده‌های واقعی است.
    *   **مغایرت تست و بیلد (بالا):** تست‌های فرانت‌اند پاس می‌شوند در حالی که پروژه قابل بیلد نیست.

---

### سناریوهای تست‌شده

*   **سناریو ۱: ثبت‌نام و ورود از طریق API**
    *   **مراحل:** اجرای درخواست `POST` به `/api/auth/register` و `/api/auth/login` با `curl`.
    *   **نتیجه:** هر دو درخواست با خطای `400 Bad Request` و پیام لزوم padding به ۴۰۹۶ بایت مواجه شدند.
    *   **تحلیل:** این رفتار **مورد انتظار و صحیح** بود و نشان می‌دهد که میان‌افزار امنیتی پنهان‌سازی ترافیک در بک‌اند به درستی کار می‌کند.

---

### نقشهٔ ارتقاء هماهنگی (Roadmap)

*   **گام‌های ۰–۲ هفته (اولویت حیاتی):**
    1.  **رفع خطاهای بیلد فرانت‌اند:** اولین و مهم‌ترین قدم، رفع تمام خطاهای TypeScript است تا پروژه قابل بیلد شود. این کار احتمالاً نیازمند بازنویسی بخش‌های بزرگی از لایه رمزنگاری و مدیریت نوع است.
    2.  **اصلاح آسیب‌پذیری E2EE در بک‌اند:** بازنویسی کامل `keyController.js` برای مدیریت صحیح کلیدهای یک‌بار مصرف طبق پروتکل X3DH.
    3.  **حذف کلیدهای خصوصی از ریپازیتوری:** فایل‌های `.pem` باید فوراً از تاریخچه git حذف شوند.

*   **۲–۶ هفته (بهبودهای اساسی):**
    1.  **همسان‌سازی Sealed Sender:** تصمیم‌گیری در مورد پروتکل "Sealed Sender". یا باید به طور کامل و صحیح پیاده‌سازی شود (با حذف فیلد `senderId` از مدل) یا مستندات باید اصلاح شود تا با واقعیت کد مطابقت داشته باشد.
    2.  **معرفی OpenAPI/Swagger:** ایجاد یک مستند OpenAPI واحد به عنوان "منبع حقیقت" (Single Source of Truth) برای API.
    3.  **بازنویسی با TypeScript Strict:** فعال‌سازی `strict: true` در `tsconfig.json` فرانت‌اند و رفع تمام خطاهای `any`.

*   **۶+ هفته (بلوغ و پایداری):**
    1.  **معرفی تست‌های Contract (PACT):** ایجاد تست‌های PACT برای اطمینان از هماهنگی دائمی بین فرانت‌اند و بک‌اند در CI.
    2.  **استانداردسازی خطاها:** پیاده‌سازی یک میان‌افزار مدیریت خطای متمرکز در بک‌اند و یک فرمت استاندارد برای پاسخ‌های خطا.
    3.  **مشاهده‌پذیری سرتاسری:** معرفی `correlation-id` و ابزارهای tracing مانند OpenTelemetry برای پیگیری درخواست‌ها از UI تا DB.